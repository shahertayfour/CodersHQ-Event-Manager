<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users Management - CHQ Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-gray-900">CHQ Admin - Users</h1>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/admin.html" class="text-gray-700 hover:text-gray-900">Bookings</a>
          <a href="/admin-users.html" class="text-indigo-600 font-semibold">Users</a>
          <button onclick="logout()" class="text-gray-700 hover:text-gray-900">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Filters</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
          <input
            type="text"
            id="searchInput"
            placeholder="Name, email, or organization..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
          <select id="roleFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="">All Roles</option>
            <option value="USER">User</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email Status</label>
          <select id="emailVerifiedFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="">All</option>
            <option value="true">Verified</option>
            <option value="false">Not Verified</option>
          </select>
        </div>
        <div class="flex items-end">
          <button
            onclick="loadUsers()"
            class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
          >
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-500">Total Users</div>
        <div id="totalUsers" class="text-3xl font-bold text-gray-900">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-500">Verified</div>
        <div id="verifiedUsers" class="text-3xl font-bold text-green-600">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-500">Not Verified</div>
        <div id="unverifiedUsers" class="text-3xl font-bold text-yellow-600">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-500">Admins</div>
        <div id="adminUsers" class="text-3xl font-bold text-indigo-600">-</div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold">Registered Users</h2>
      </div>
      <div id="loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
      <div id="usersTable" class="hidden overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organization</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bookings</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
            </tr>
          </thead>
          <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Users will be inserted here -->
          </tbody>
        </table>
      </div>
      <div id="noUsers" class="hidden text-center py-8 text-gray-500">
        No users found
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    let allUsers = [];

    async function loadUsers() {
      const loading = document.getElementById('loading');
      const usersTable = document.getElementById('usersTable');
      const noUsers = document.getElementById('noUsers');
      const usersTableBody = document.getElementById('usersTableBody');

      loading.classList.remove('hidden');
      usersTable.classList.add('hidden');
      noUsers.classList.add('hidden');

      try {
        const search = document.getElementById('searchInput').value;
        const role = document.getElementById('roleFilter').value;
        const emailVerified = document.getElementById('emailVerifiedFilter').value;

        let url = ENDPOINTS.ADMIN_USERS;
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (role) params.append('role', role);
        if (emailVerified) params.append('emailVerified', emailVerified);

        if (params.toString()) {
          url += '?' + params.toString();
        }

        allUsers = await API.get(url);

        loading.classList.add('hidden');

        if (allUsers.length === 0) {
          noUsers.classList.remove('hidden');
          updateStats();
          return;
        }

        usersTable.classList.remove('hidden');
        renderUsers(allUsers);
        updateStats();
      } catch (error) {
        loading.classList.add('hidden');
        alert('Error loading users: ' + error.message);
      }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = users.map(user => `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div>
                <div class="text-sm font-medium text-gray-900">
                  ${user.firstName || ''} ${user.lastName || ''}
                </div>
                <div class="text-sm text-gray-500">${user.email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${user.phoneNumber || '-'}</div>
            <div class="text-sm text-gray-500">${user.jobTitle || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${user.entity || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
              user.role === 'ADMIN' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'
            }">
              ${user.role}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
              user.emailVerified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
            }">
              ${user.emailVerified ? 'Verified' : 'Not Verified'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${user._count.bookings}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${Utils.formatDate(user.createdAt)}
          </td>
        </tr>
      `).join('');
    }

    function updateStats() {
      document.getElementById('totalUsers').textContent = allUsers.length;
      document.getElementById('verifiedUsers').textContent = allUsers.filter(u => u.emailVerified).length;
      document.getElementById('unverifiedUsers').textContent = allUsers.filter(u => !u.emailVerified).length;
      document.getElementById('adminUsers').textContent = allUsers.filter(u => u.role === 'ADMIN').length;
    }

    async function logout() {
      try {
        await Auth.logout();
      } catch (error) {
        console.error('Logout error:', error);
        localStorage.clear();
        window.location.href = '/login.html';
      }
    }

    // Search on input
    document.getElementById('searchInput').addEventListener('input', () => {
      loadUsers();
    });

    // Load users on page load
    loadUsers();
  </script>
</body>
</html>
